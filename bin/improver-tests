#!/bin/bash
#------------------------------------------------------------------------------
# (C) British Crown Copyright 2017 Met Office.
#------------------------------------------------------------------------------
# NAME
#    improver tests - Run IMPROVER self-tests
#
# SYNOPSIS
#    improver tests
#
# DESCRIPTION
#    Launch all IMPROVER self-tests.
#------------------------------------------------------------------------------

set -eu

function echo_ok {
    echo -e "\033[1;32m[OK]\033[0m $1"
}

function improver_test_pep8 {
    # PEP8 testing.
    ${PEP8:-pep8} improver
    echo_ok "pep8"
}

function improver_test_pylint {
    # Pylint obvious-errors-only testing.
    ${PYLINT:-pylint} --rcfile=../etc/pylintrc improver
}

function improver_test_pylintE {
    # Pylint obvious-errors-only testing.
    ${PYLINT:-pylint} -E --rcfile=../etc/pylintrc improver
    echo_ok "pylint -E"
}

function improver_test_doc {
    # Build documentation as test.
    cd $IMPROVER_DIR/doc
    make html 1>/dev/null
    echo_ok "sphinx-build -b html"
    cd -
}

function improver_test_unit {
    # Unit tests.
    python -m unittest discover
    echo_ok "Unit tests"
}

function improver_test_cli {
    # CLI testing.
    PATH="$IMPROVER_DIR/tests/bin/:$PATH"
    if [[ ${1:-} != '--debug' ]] && type prove &>/dev/null; then
        prove -j $(nproc) -r -e "bats --tap" \
            --ext ".bats" "$IMPROVER_DIR/tests/"
    else
        bats $(find "$IMPROVER_DIR/tests/" -name "*.bats")
    fi
    echo_ok "CLI tests"
}

cd $IMPROVER_DIR/lib

if [[ ${1:-} == '--help' ]] || [[ ${1:-} == '-h' ]]; then
    cat <<'__USAGE__'
improver tests [--debug] [SUBTEST] 

Run pep8, pylint, documentation, unit and CLI acceptance tests.

Optional arguments:
    --debug         Run in verbose mode (may take longer for CLI)
    -h, --help          Show this message and exit

Arguments:
    SUBTEST         Name of a subtest to run without running the rest.
                    Valid names are: pep8, pylint, pylintE, unit, cli.
                    pep8, pylintE, unit, and cli are the default tests.
__USAGE__
    exit 0
fi

DEBUG_OPT=
if [[ "${1:-}" == '--debug' ]]; then
    DEBUG_OPT='--debug'
    shift
fi

if [[ -n "${1:-}" ]]; then
    TEST_NAME="improver_test_$1"
    shift
    if [[ $(type -t $TEST_NAME) == 'function' ]]; then
        "$TEST_NAME" "$@" "$DEBUG_OPT"
        exit 0
    fi
    improver tests --help
    exit 2
fi

for test_name in pep8 pylintE doc unit cli; do
    "improver_test_$test_name" "$DEBUG_OPT" "$@"
done

# No errors found (or script would have exited).
echo_ok "All tests passed."
